<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>User List</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
    <div class="container">
        <h2>User List</h2>
        <form name="userForm">
            <input type="hidden" name="id" value="0" />
            <div class="form-group">
                <label for="name">Name:</label>
                <input class="form-control" name="name" required />
            </div>
            <div class="form-group">
                <label for="age">Age:</label>
                <input class="form-control" name="age" type="number" required />
            </div>
            <div class="panel-body">
                <button type="submit" class="btn btn-sm btn-primary">Save</button>
                <button id="reset" class="btn btn-sm btn-primary" type="button">Reset</button>
            </div>
        </form>
        <table class="table table-condensed table-striped table-bordered">
            <thead>
                <tr><th>ID</th><th>Name</th><th>Age</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
    // Load all users
    async function GetUsers() {
        const response = await fetch("/api/users");
        if (response.ok) {
            const users = await response.json();
            const rows = document.querySelector("tbody");
            rows.innerHTML = "";
            users.forEach(u => rows.append(row(u)));
        }
    }

    // Load one user
    async function GetUser(id) {
        const response = await fetch("/api/users/" + id);
        if (response.ok) {
            const user = await response.json();
            const form = document.forms["userForm"];
            form.id.value = user._id;
            form.name.value = user.name;
            form.age.value = user.age;
        }
    }

    // Create new user
    async function CreateUser(name, age) {
        const response = await fetch("/api/users", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, age: Number(age) })
        });

        if (response.ok) {
            const user = await response.json();
            document.querySelector("tbody").append(row(user));
            reset();
        }
    }

    // Edit user
    async function EditUser(id, name, age) {
        const response = await fetch("/api/users", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id, name, age: Number(age) })
        });

        if (response.ok) {
            const user = await response.json();
            document.querySelector(`tr[data-rowid='${user._id}']`).replaceWith(row(user));
            reset();
        }
    }

    // Delete user
    async function DeleteUser(id) {
        const response = await fetch("/api/users/" + id, { method: "DELETE" });
        if (response.ok) {
            const user = await response.json();
            document.querySelector(`tr[data-rowid='${user._id}']`).remove();
        }
    }

    // Clear form
    function reset() {
        const form = document.forms["userForm"];
        form.id.value = 0;
        form.name.value = "";
        form.age.value = "";
    }

    // Create table row
    function row(user) {
        const tr = document.createElement("tr");
        tr.dataset.rowid = user._id;

        tr.innerHTML = `
            <td>${user._id}</td>
            <td>${user.name}</td>
            <td>${user.age}</td>
            <td>
                <a style="cursor:pointer; padding:10px;" class="edit">Edit</a>
                <a style="cursor:pointer; padding:10px;" class="delete">Delete</a>
            </td>
        `;

        tr.querySelector(".edit").onclick = () => GetUser(user._id);
        tr.querySelector(".delete").onclick = () => DeleteUser(user._id);

        return tr;
    }

    document.getElementById("reset").onclick = reset;

    document.forms["userForm"].onsubmit = e => {
        e.preventDefault();
        const f = e.target;

        if (f.id.value == 0) CreateUser(f.name.value, f.age.value);
        else EditUser(f.id.value, f.name.value, f.age.value);
    };

    GetUsers();
    </script>
</body>
</html>
